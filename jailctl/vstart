#!/usr/local/bin/cbsd
#v10.1.2
MYARG=""
MYOPTARG="jname inter debug"
MYDESC="Start jail"
ADDHELP="inter=0 to prevent any questions and to accept answers by default\n"
CBSDMODULE="virtualbox"
EXTHELP="wf_jstop_jstart.html"

. ${subr}
. ${system}
. ${strings}
. ${workdir}/universe.subr
. ${workdir}/virtualbox.subr
. ${tools}

readconf buildworld.conf
readconf jail-freebsd-default.conf
. ${workdir}/virtualbox.subr

[ -z "${1}" ] && select_jail_by_list -s "List of offline VMs" -a "Off" -e bls -r ${sqlreplica}
init $*

. ${workdir}/fetch.subr

# MAIN
init_virtualbox

[ -z "$jname" ] && jname=$1
. ${jrcconf}
[ $? -eq 1 ] && err 1 "${MAGENTA}No such jail: ${GREEN}${jname}${NORMAL}"
[ ${status} -eq 2 ] && err 1 "${MAGENTA}Jail in slave mode. Please ${GREEN}cbsd jswmode mode=master${MAGENTA} first${NORMAL}"
[ $jid -ne 0 ] && err 1 "${MAGENTA}Jail ${jname} already running, jid: ${GREEN}${jid}${NORMAL}"
[ "${emulator}" != "virtualbox" ] && err 1 "${MAGENTA}Not virtualbox mode${NORMAL}"
[ -z "${vm_ram}" -o -z "${vm_cpus}" -o -z "${vm_os_type}" ] && err 1 "${MAGENTA}Parameter is mandatory: ${GREEN}vm_ram, vm_cpus, vm_os_type${NORMAL}"

vm_ram=$(( vm_ram / 1024 / 1024 ))
${VBOX_MGMT_CMD} modifyvm ${jname} --memory ${vm_ram} --cpus ${vm_cpus} --floppy disabled --audio none --nic1 bridged --bridgeadapter1 re0 --vram 4 --accelerate3d off --boot1 disk --acpi on --cableconnected1 on --usb off --vrde on --vrdeport ${vm_vnc_port}

readconf bhyve-${vm_os_type}-${vm_os_profile}.conf
[ -z "${bhyve_profile}" ] && err 1 "${MAGENTA}No such profile: ${GREEN}bhyve-${vm_os_type}-${vm_os_profile}.conf${NORMAL}"
# re-read jail params and apply personal after profile
. ${jrcconf}

check_for_empty_hdd

[ "${vm_iso_path}" != "0" ] && iso_img="${vm_iso_path}"
if [ "${vm_boot}" = "cd" ]; then
	init_iso
	if [ $? -eq 1 ]; then
		printf "${MAGENTA}Continue without ${iso_img}. Hope this is ok, sleep for 5 seconds ${NORMAL}"
		for i in $( jot 5 ); do
			printf "."
			sleep 1
		done
		echo
	fi
fi

case "${vm_boot}" in
	"hdd")
		${VBOX_MGMT_CMD} modifyvm ${jname} --boot1 dvd
		;;
	"cd")
		${VBOX_MGMT_CMD} modifyvm ${jname} --boot1 disk
		${VBOX_MGMT_CMD} storageattach ${jname} --storagectl "IDE Controller" --port 1 --device 0 --type dvddrive --medium ${iso_img}
		;;
esac

/usr/sbin/daemon -f ${VBOX_HEADLESS_CMD} --startvm ${jname}

exit 0
