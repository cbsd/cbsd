#!/bin/sh

jname="cbsd_test_jstart"

oneTimeSetUp() {
    cbsd jdestroy jname="${jname}"
}

setUp() {
    cbsd jcreate runasap=0 jname="${jname}"
}

tearDown() {
    cbsd jdestroy jname="${jname}"
}

# just test if jstart works at all
test_jstart(){
    cbsd jstart jname="${jname}"
    _test=$(jexec "${jname}" whoami)
    assertEquals "${_test}" "root"
}


# https://github.com/cbsd/cbsd/issues/649
# change host_hostname
test_issue649_0() {
    cbsd jset jname="${jname}" host_hostname="one"
    _test=$(cbsd jget jname="${jname}" host_hostname)
    assertEquals "host_hostname: one" "${_test}"
}

# change host_hostname on-the-fly
test_issue649_1() {
    cbsd jstart jname="${jname}"
    cbsd jset jname="${jname}" host_hostname="two"
    cbsd jrestart jname="${jname}"
    _test=$(cbsd jget jname="${jname}" host_hostname)
    assertEquals "host_hostname: two" "${_test}"
}

# change hostname from inside jail
test_issue649_2() {
    cbsd jstart jname="${jname}"
    cbsd jexec jname="${jname}" sysrc hostname="lollipop"
    cbsd jstop jname="${jname}"
    cbsd jstart jname="${jname}"
    _test=$(cbsd jexec jname="${jname}" hostname)
    assertEquals "${_test}" "lollipop"
}

. shunit2
