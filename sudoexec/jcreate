#!/bin/sh
#v10.0.0
globalconf="${workdir}/cbsd.conf";
MYARG="jconf"
MYOPTARG="inter ver arch"
MYDESC="Create jail from config file"
ADDHELP="inter=0 to prevent any questions and to accept answers by default\n"
CBSDMODULE="jail"

[ -f ${globalconf} ] || err 1 "no such conf file";
. ${globalconf}
. ${subr}
. ${system}
. ${inventory}
. ${tools}
. ${mdtools}
. ${jfs}
. ${color}

init $*

mkfstab() {
    if [ $baserw -eq 0 ]; then
	cat > ${mount_fstab} << EOF
# Please do not edit this file for additional fstabs
# Use ${jailfstabdir}/${jailfstabpref}local instead
${data}/etc /etc nullfs rw 0 0
${data}/root /root nullfs rw 0 0
${data}/tmp /tmp nullfs rw 0 0
${data}/usr/home /usr/home nullfs rw 0 0
${data}/usr/local /usr/local nullfs rw 0 0
${data}/usr/compat /usr/compat nullfs rw 0 0
${data}/var /var nullfs rw 0 0
#
EOF
    fi
}

### MAIN
[ -f "$jconf" ] || err 1 "${MAGENTA}no such jconf file${NORMAL}";
over="${ver}"
oarch="${arch}"
jconf=`realpath $jconf`

temprcconf="${ftmpdir}/jcreate_jconf.$$"

cp ${jconf} ${temprcconf}

trap "rm -f ${temprcconf} ${jconf}" HUP INT ABRT BUS TERM  EXIT

. ${temprcconf}
. ${buildconf}
. ${temprcconf}

cbsd jstatus jname=${jname} > /dev/null 2>&1
[ $? -eq 0 ] || err 1 "${MAGENTA}Jail with $jname already exist${NORMAL}"

get_base

# ip validate
if [ -n "${interface}" -a "${inteface}" != "0" ]; then
	### CHECK FOR IP ( 1 - check for interfaces) ####
	cbsd checkip ip=${ips} check=1 > /dev/null 2>&1
	case $? in
	    0) err 1 "${MAGENTA}Ip not in pool range${NORMAL}"
		;;
	    1)	;;
	    2) ${ECHO} "${MAGENTA}Warning:${GREEN} Ip already exists in LAN${NORMAL}"
		;;
	    *) err 1 "Unknown code from checkip"
	;;
	esac
fi

${ECHO} "${MAGENTA}Please wait: ${GREEN}this will take a while...${NORMAL}"

[ -d "${data}" ] && removedata ${data}

case $zfsfeat in
	"0") [ -d ${data} ] || mkdir -p ${data}
	    ;;
	"1") . $zfstool
	    ZPOOL=`zfs get -Ho value name ${jaildatadir}`

	    if zfsroot $jname; then
		err 1 "$ZPOOL/$jname already in use"
	    fi

	    zfs create -o atime=off -o mountpoint=${data} ${ZPOOL}/$jname
	    ;;
esac

[ ! -d "${data}" ] && err 1 "Can't create datadir ${data}"
[ ! -d ${path} -a "${baserw}" -eq 0 ] && mkdir -p ${path}
[ ! -d ${jailfstabdir}  ] && mkdir -p ${jailfstabdir}
[ ! -d "${jailsysdir}/${jname}" ] && mkdir -p ${jailsysdir}/${jname}

## MD backend place
if [ "${mdsize}" != "0" ]; then
    conv2bytes "${mdsize}" || err 1 "conv2bytes error from ${mdsize}"
    imgbytes=$convval
    blockcount=$(( imgbytes  / 1048576 ))
    mdimage="${jailsysdir}/${jname}/image.dat"
    touch "${mdimage}"
    dd if="/dev/zero" of="${mdimage}" bs=1m count=0 seek=${blockcount} 1> /dev/null 2>&1 || err 1 "Error: Couldn't create the image file. ${mdimage}"
    # Attach the .img file as a memory disk.
    mdimagedevice=`mdconfig -a -t vnode -f "${mdimage}"`
    [ $? -eq 0 ] || err 1 "Error: Failed to mdconfig on ${mdimage}"
    newfs -j -n -U "/dev/${mdimagedevice}" 1> /dev/null 2>&1 || mdconfig -d -u ${mdimagedevice} || err 1 "Error: Couldn't newfs the memory disk. ${mdimagedevice}"
    mdconfig -d -u ${mdimagedevice}
# mount here
    cbsd mountmd jroot=${data} mdfile=${mdimage}
fi
## MD backend

### COPY FROM BASE
if [ "${ver}" != "empty" ]; then
    if [ "$baserw" = "1" ]; then
#basepath variable from get_base
	if ! populate_cdir ${basepath} ${data}; then
	    [ "${mdsize}" != "0" ] && cbsd unmountmd jroot=${data}
	    err 1 "Can't populate $data from $basepath"
	fi
    else
	cp -rP ${basepath}/etc ${data}/
	cp -rP ${basepath}/root ${data}/
	[ -f "${basepath}/etc/mtree/BSD.root.dist" ] && mtree -deU -f ${basepath}/etc/mtree/BSD.root.dist -p ${data} >/dev/null
	[ -f "${basepath}/etc/mtree/BSD.usr.dist" ] && mtree -deU -f ${basepath}/etc/mtree/BSD.usr.dist -p ${data}/usr >/dev/null
	[ -f "${basepath}/etc/mtree/BSD.var.dist" ] && mtree -deU -f ${basepath}/etc/mtree/BSD.var.dist -p ${data}/var >/dev/null
	# in FreeBSD10 BIND is go away
	if [ -f "${basepath}/etc/mtree/BIND.chroot.dist" ]; then
	    [ ! -d "${data}/var/named" ] && mkdir ${data}/var/named
	    mtree -deU -f ${basepath}/etc/mtree/BIND.chroot.dist -p ${data}/var/named >/dev/null
	fi
	[ -f "${basepath}/etc/mtree/BSD.sendmail.dist" ] && mtree -deU -f ${basepath}/etc/mtree/BSD.sendmail.dist -p ${data} >/dev/null
    fi

    touch "${data}/etc/fstab"

    [ ! -d ${data}/usr/home ] && mkdir ${data}/usr/home
    [ ! -d ${data}/usr/local ] && mkdir ${data}/usr/local
    [ ! -d ${data}/usr/compat ] && mkdir ${data}/usr/compat
    [ ! -d ${data}/usr/ports ] && mkdir ${data}/usr/ports
    [ ! -d ${data}/usr/local/etc ] && mkdir -p ${data}/usr/local/etc

    if [ ${applytpl} -eq 1 ]; then

	if [ -d "${jailskeldir}" ]; then
	    cd ${jailskeldir} && find -E ${jailskeldir} \( -type f -or -type d -or -type l \) -print |sed s:${jailskeldir}:./:g |cpio -pdmu ${data} > /dev/null 2>&1
	fi
	
	if [ -f ${data}/master.passwd ]; then
	    /usr/sbin/pwd_mkdb -d ${data}/etc ${data}/etc/master.passwd
	fi

	[ ! -f ${data}/etc/localtime ] && cp /etc/localtime ${data}/etc

    fi
fi  # if ver = empty

mkfstab
cp $temprcconf $rcconf

[ ${applytpl} -eq 1 ] && ${miscdir}/config_pkgrepo -t ${etcdir}/pkg.conf -v ${ver} -a ${arch} ${data}

# pkg area
if [ "${pkglist}" != "NO" -a "${ver}" != "empty" -a -f "${pkglist}" ]; then
    ${ECHO} "${MAGENTA}Populate jail from pkglist: ${GREEN}${pkglist}${NORMAL}"
    mountbase
    cbsd mountfstab jroot=${path} fstab=${mount_fstab} > /dev/null 2>&1
    mount -t devfs devfs $path/dev

    [ ! -d "${path}/usr/local/etc" ] && mkdir ${path}/usr/local/etc

    printf "${MAGENTA}pkg: [${GREEN}bootstrap... "
    chroot ${path} env ASSUME_ALWAYS_YES=yes pkg > /dev/null 2>&1
    # remove default pkg.conf
    #[ -f "${path}/usr/local/etc/pkg.conf" ] && rm -f ${path}/usr/local/etc/pkg.conf
    printf "looking for new version... "
    chroot ${path} env ASSUME_ALWAYS_YES=yes pkg update -f > /dev/null 2>&1
    #lets upgrade pkg if new version available
    printf "upgrading... "
#need for pkg upgrade twice for reinstalling pkg with "needed shared library changed"
    chroot ${path} env ASSUME_ALWAYS_YES=yes pkg upgrade -f > /dev/null 2>&1
#need for pkg upgrade twice for reinstalling pkg with "needed shared library changed"
    chroot ${path} env ASSUME_ALWAYS_YES=yes pkg upgrade -f > /dev/null 2>&1
    PKGLIST=`cat ${pkglist} |xargs`
    printf "install for ${PKGLIST}...${MAGENTA}]${NORMAL}\n"
    chroot ${path} env ASSUME_ALWAYS_YES=yes pkg install ${PKGLIST}
    cbsd unmountfstab jroot=${path} fstab=${mount_fstab} > /dev/null 2>&1
    umount -f ${path}/dev
    unmountbase
    rm -f ${pkglist}
fi

[ "${mdsize}" != "0" ] && cbsd unmountmd jroot=${data}

# Finnaly export to SQLite
cbsd jregister jname=${jname} mode=new

if [ $? -eq 0 ]; then
    ${ECHO}
    ${ECHO} "${MAGENTA}Creating ${jname} complete: ${GREEN}Enjoy!${NORMAL}"
    rm -f $rcconf
else
    ${ECHO}
    ${ECHO} "${MAGENTA}Creating ${jname} failed: ${GREEN}cbsd jregister${NORMAL}"
    ${ECHO} "${MAGENTA}Please review bad config file: ${GREEN}/tmp/rc.conf_${jname}${NORMAL}"
    mv $rcconf /tmp
    #cleanup
    [ -f "${mount_fstab}" ] && rm -f ${mount_fstab}
    removedata ${data}
fi
